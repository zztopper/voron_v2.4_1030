  
#####################################################################
#  Spoolman location tracking
#####################################################################
# Shell command to update spool location in Spoolman via REST API
[gcode_shell_command update_spoolman_location]
command: bash /home/pi/printer_data/config/script/update_spoolman_location.sh
timeout: 10
verbose: False

# Override AFC's SET_SPOOL_ID to also update location in Spoolman.
# When the Mainsail AFC Plugin assigns a spool to a lane, we intercept
# the call, run the original AFC command, then PATCH the spool's
# location in Spoolman to match the BoxTurtle lane.
[gcode_macro SET_SPOOL_ID]
rename_existing: _AFC_SET_SPOOL_ID
gcode:
  {% set lane = params.LANE|default('')|string %}
  {% set spool_id = params.SPOOL_ID|default(0)|int %}
  ; Run the original AFC SET_SPOOL_ID (fetches spool data from Spoolman)
  _AFC_SET_SPOOL_ID LANE={lane} SPOOL_ID={spool_id}
  ; Update the spool's location in Spoolman to reflect the lane
  {% if spool_id > 0 and lane != '' %}
    RUN_SHELL_COMMAND CMD=update_spoolman_location PARAMS="{spool_id} {lane}"
    {action_respond_info("Spoolman: spool %d location updated to %s" % (spool_id, lane))}
  {% endif %}

# Move a spool back to the Shelf location in Spoolman (use when
# physically removing a spool from a lane).
# Usage: RETURN_SPOOL_TO_SHELF SPOOL_ID=42
[gcode_macro RETURN_SPOOL_TO_SHELF]
description: Update spool location in Spoolman back to Shelf
gcode:
  {% set spool_id = params.SPOOL_ID|default(0)|int %}
  {% if spool_id > 0 %}
    RUN_SHELL_COMMAND CMD=update_spoolman_location PARAMS="{spool_id} shelf"
    {action_respond_info("Spoolman: spool %d returned to Shelf" % spool_id)}
  {% else %}
    {action_respond_info("Parameter SPOOL_ID is required")}
  {% endif %}
